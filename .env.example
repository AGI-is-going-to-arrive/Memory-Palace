# =============================================================================
# Memory Palace - Configuration
# =============================================================================
# Copy to .env and edit:
#   cp .env.example .env
# Or generate from profiles:
#   bash scripts/apply_profile.sh macos c
#   # Windows: .\scripts\apply_profile.ps1 -Platform windows -Profile c
#
# Unified C/D note:
# - Phase C/D uses the same hybrid retrieval pipeline.
# - First tuning knob: RETRIEVAL_RERANKER_WEIGHT.
# =============================================================================

# SQLite database path (must be absolute)
DATABASE_URL=sqlite+aiosqlite:////absolute/path/to/memory_palace/demo.db

# Schema migration lock (prevents concurrent migration conflicts)
# Optional: if empty, defaults to "<db_file>.migrate.lock" beside DATABASE_URL target.
DB_MIGRATION_LOCK_FILE=
DB_MIGRATION_LOCK_TIMEOUT_SEC=10

# Memory URI domains
VALID_DOMAINS=core,writer,game,notes

# Auto-loaded memories on system://boot
CORE_MEMORY_URIS=core://agent,core://my_user,core://agent/my_user

# =============================================================================
# Retrieval / Search
# =============================================================================
# keyword | semantic | hybrid
# For Unified C/D, set this to hybrid.
SEARCH_DEFAULT_MODE=keyword

SEARCH_DEFAULT_MAX_RESULTS=10
SEARCH_DEFAULT_CANDIDATE_MULTIPLIER=4
SEARCH_HARD_MAX_RESULTS=100
SEARCH_HARD_MAX_CANDIDATE_MULTIPLIER=50

RETRIEVAL_CHUNK_SIZE=1000
RETRIEVAL_CHUNK_OVERLAP=200

# Hybrid score weights
RETRIEVAL_HYBRID_KEYWORD_WEIGHT=0.7
RETRIEVAL_HYBRID_SEMANTIC_WEIGHT=0.3
RETRIEVAL_WEIGHT_PRIORITY=0.1
RETRIEVAL_WEIGHT_RECENCY=0.06
RETRIEVAL_WEIGHT_PATH_PREFIX=0.04
RETRIEVAL_RECENCY_HALF_LIFE_DAYS=30

# Embedding backend:
# - hash: built-in local hash embedding
# - none: disable semantic index (fallback keyword)
# - router/api/openai: call OpenAI-compatible /embeddings API
# IMPORTANT: even local model servers should be configured via *_API_BASE/*_API_KEY/*_MODEL.
RETRIEVAL_EMBEDDING_BACKEND=none
RETRIEVAL_EMBEDDING_MODEL=
RETRIEVAL_EMBEDDING_DIM=64
RETRIEVAL_EMBEDDING_API_BASE=
RETRIEVAL_EMBEDDING_API_KEY=
RETRIEVAL_REMOTE_TIMEOUT_SEC=8

# Optional router aliases (when backend=router)
ROUTER_API_BASE=
ROUTER_API_KEY=
ROUTER_EMBEDDING_MODEL=

# Optional reranker (OpenAI-compatible style endpoint)
RETRIEVAL_RERANKER_ENABLED=false
RETRIEVAL_RERANKER_API_BASE=
RETRIEVAL_RERANKER_API_KEY=
RETRIEVAL_RERANKER_MODEL=

# First tuning knob for Unified C/D.
# Typical range: 0.20 ~ 0.40
RETRIEVAL_RERANKER_WEIGHT=0.25

# =============================================================================
# LLM Decisions (Write Guard / Compact Gist)
# =============================================================================
# OpenAI-compatible chat endpoint (expects /chat/completions support).
WRITE_GUARD_LLM_ENABLED=false
WRITE_GUARD_LLM_API_BASE=
WRITE_GUARD_LLM_API_KEY=
WRITE_GUARD_LLM_MODEL=

# compact_context gist stage-1 LLM.
# If COMPACT_GIST_LLM_* is empty, runtime falls back to WRITE_GUARD_LLM_*.
COMPACT_GIST_LLM_ENABLED=false
COMPACT_GIST_LLM_API_BASE=
COMPACT_GIST_LLM_API_KEY=
COMPACT_GIST_LLM_MODEL=

# =============================================================================
# Runtime / Queue / Index Worker
# =============================================================================
RUNTIME_SESSION_FIRST_SEARCH=true

RUNTIME_WRITE_LANE_QUEUE=true
RUNTIME_WRITE_GLOBAL_CONCURRENCY=1
RUNTIME_WRITE_WAIT_WARN_MS=2000

RUNTIME_SESSION_CACHE_MAX_HITS=200
RUNTIME_SESSION_CACHE_HALF_LIFE_SECONDS=21600

RUNTIME_INDEX_WORKER_ENABLED=true
RUNTIME_INDEX_DEFER_ON_WRITE=true
RUNTIME_INDEX_QUEUE_MAXSIZE=256
RUNTIME_INDEX_RECENT_JOBS=30
RUNTIME_VITALITY_DECAY_CHECK_INTERVAL_SECONDS=600
RUNTIME_CLEANUP_REVIEW_TTL_SECONDS=900
RUNTIME_CLEANUP_REVIEW_MAX_PENDING=64

# Maintenance API gate (protects /maintenance/* and SSE)
# Accepts either:
# - X-MCP-API-Key: <MCP_API_KEY>
# - Authorization: Bearer <MCP_API_KEY>
MCP_API_KEY=
# Default is fail-closed when MCP_API_KEY is empty.
# Enable only for local debugging when you explicitly accept insecure access.
MCP_API_KEY_ALLOW_INSECURE_LOCAL=false

RUNTIME_AUTO_FLUSH_ENABLED=true
RUNTIME_AUTO_FLUSH_PARENT_URI=notes://
RUNTIME_AUTO_FLUSH_PRIORITY=2
RUNTIME_AUTO_FLUSH_SUMMARY_LINES=12
RUNTIME_FLUSH_TRIGGER_CHARS=6000
RUNTIME_FLUSH_MIN_EVENTS=6
RUNTIME_FLUSH_MAX_EVENTS=80

# =============================================================================
# Vitality / Cleanup 
# =============================================================================
VITALITY_MAX_SCORE=3.0
VITALITY_REINFORCE_DELTA=0.08
VITALITY_DECAY_HALF_LIFE_DAYS=30
VITALITY_DECAY_MIN_SCORE=0.05
VITALITY_CLEANUP_THRESHOLD=0.35
VITALITY_CLEANUP_INACTIVE_DAYS=14
